pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: 'Release'
  prPipeline: $[eq(variables['Build.Reason'], 'PullRequest')]

steps:
- task: SonarQubePrepare@5  
  inputs:
    SonarQube: 'SonarQube Developer Edition'
    scannerMode: 'MSBuild'
    projectKey: '$(SONAR_PROJECT_KEY)'

- task: DotNetCoreCLI@2
  displayName: 'Calculate code coverage'
  continueOnError: false
  inputs:
    command: test
    projects: '**/*[Tt]ests/*.csproj'
    arguments: '--configuration $(BuildConfiguration) /p:CollectCoverage=true /p:CoverletOutput=../TestResults/ /p:CoverletOutputFormat="json%2ccobertura" /p:MergeWith=../TestResults/coverage.json  /m:1'
    publishTestResults: false

- task: DotNetCoreCLI@2
  displayName: 'Checkpoint: Total branch coverage >= $(codeCoverageBranchThreshold)'
  continueOnError: false
  inputs:
    command: test
    projects: '**/*[Tt]ests/*.csproj'
    arguments: '--configuration $(BuildConfiguration) /p:CollectCoverage=true /p:CoverletOutput=../TestResults/ /p:CoverletOutputFormat="json%2ccobertura" /p:MergeWith=../TestResults/coverage.json /p:ThresholdType=branch /p:Threshold=$(codeCoverageBranchThreshold) /p:ThresholdStat=total'
    publishTestResults: false

- task: SonarQubePublish@5
  displayName: 'Publishing sonarqube analizys'
  inputs:
    pollingTimeoutSec: '300'